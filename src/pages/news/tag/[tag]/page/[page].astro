---
import Base from '@/layouts/BaseLayout.astro';
import NewsList from '@/components/NewsList.astro';
import Pagination from '@/components/Pagination.astro';
import { getCollection } from 'astro:content';
import { slugify } from '@/utils/slug';

const PAGE_SIZE = 10;

export async function getStaticPaths() {
  const news = await getCollection('news');
  const tags = new Map<string, string>();
  for (const n of news) {
    for (const t of n.data.tags ?? []) {
      const s = slugify(t);
      if (!tags.has(s)) tags.set(s, t);
    }
  }
  const paths: any[] = [];
  for (const [slug, original] of tags) {
    const filtered = news.filter((n) => (n.data.tags ?? []).some((t) => slugify(t) === slug)).sort((a, b) => +new Date(b.data.date) - +new Date(a.data.date));
    const pageCount = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
    for (let i = 1; i <= pageCount; i++) {
      paths.push({ params: { tag: slug, page: String(i) }, props: { tag: original, slug, news: filtered, page: i, pageCount } });
    }
  }
  return paths;
}

const { tag, slug, news, page, pageCount } = Astro.props as { tag: string; slug: string; news: any[]; page: number; pageCount: number };
const start = (page - 1) * PAGE_SIZE;
const items = news.slice(start, start + PAGE_SIZE);
---
<Base title={`ニュース: #${tag} - ページ${page}`}>
  <section class="mx-auto max-w-6xl px-4 py-10">
    <h1 class="text-3xl font-bold">タグ: #{tag}</h1>
    <div class="mt-6">
      <NewsList items={items} />
    </div>
    <Pagination page={page} pageCount={pageCount} basePath={`/news/tag/${slug}/page`} />
  </section>
</Base>
